
# Code is associated with the following sections of the article

# Results
# Run the climate match among each ecoregions

# clean working environment
rm(list=ls())

# Load packages
library(devtools)
library(Rcpp)

############################################
# The climate matching algorithm 'CLIMATE' is much faster when utilizing the C++ interface
 
cppFunction('
            double percsim(NumericMatrix iarea, NumericMatrix jarea, NumericVector gv, double var){
            int mn = iarea.nrow();
            int jn = jarea.nrow();
            double perc = 0;
            NumericVector cs(11);
            NumericVector jmax(jn);
            for(int j=0; j<jn; j++){
            double imin = 0;
            NumericVector biosum(mn);
            NumericVector ja = jarea(j,_);
            for(int i=0; i<mn; i++){
            double biovar = 0.0;
            NumericVector ia = iarea(i,_);
            for(int m=0; m<var; m++){
            biovar = (pow((ia[m]-ja[m]),2)/gv[m]) + biovar;
            }
            biosum[i] = sqrt(1/var*biovar);
            }
            imin = min(biosum);
            jmax[j] = floor((1-imin)*10);
            }
            for(int z=0; z<11; z++){
            cs[z]= std::count(jmax.begin(), jmax.end(), z);
            }
            for(int b=6; b<11; b++){
            perc=cs[b]+perc;
            }
            perc = (perc/jn)*100;
            return perc;
            }')


# For simple integration in R, 
climatch<-function(jarea, iarea, globvar){
  jare<-as.matrix(jarea) # Matrix of climate data for a recipient region with variables in the columns, and grid cells in rows
  iare<-as.matrix(iarea) # Same as above but for source region
  var<-ncol(jare) # Number of variables
  #globvar is a vector of the global variance for each climate variable
  percsim(jarea=jare, iarea=iare, gv=globvar, var=var) 
}

## Function that runs the pairwise climatches and select the bioclim variables to use for each a taxa
climatchpair <- function(recipient, source, globalvar, biovar = NULL) {
  n <- length(recipient)
  climatch.pairwise <- matrix(nrow=n, ncol=n)
  for (i in 1:n) {
    rec.temp <- recipient[[i]][, biovar, drop = FALSE]
    for (j in 1:n) {
      sor.temp <- source[[j]][, biovar, drop = FALSE]
      climatch.pairwise[i,j] <- climatch(jarea=rec.temp, iarea=sor.temp, globvar=globalvar)
    }
  }
  return(climatch.pairwise)
}

########
# Load data

# Load feow data
load("clim.dat.feow.hist.Rda")
load("clim.dat.feow.90.370.Rda")
load("clim.dat.feow.90.585.Rda")

# Load teow data
load("clim.dat.teow.hist.Rda")
load("clim.dat.teow.90.370.Rda")
load("clim.dat.teow.90.585.Rda")

# Load global variances
load("glob.var.hist.Rda")
load("glob.var.90.370.Rda")
load("glob.var.90.585.Rda")


# The bioclim variabless to include in the climate matching for each taxa: Terrestrial plants (tp), terrestrial animals (ta), aquatic animals (aa)
tp<-c(1,6,10,11)
ta<-c(1,6,10,11)
aa<-c(1,6,9,11)

# Save the data

# Freshwater ecoregions climatch
climatch.aa.hist<-climatchpair(recipient = clim.dat.feow.hist, source = clim.dat.feow.hist, globalvar = glob.var.hist[aa], biovar = aa)
climatch.aa.90.370<-climatchpair(recipient = clim.dat.feow.90.370, source = clim.dat.feow.90.370, globalvar = glob.var.90.370[aa], biovar = aa)
climatch.aa.90.585<-climatchpair(recipient = clim.dat.feow.90.585, source = clim.dat.feow.90.585, globalvar = glob.var.90.585[aa], biovar = aa)

save(climatch.aa.hist, file="climatch.aa.hist.Rda")
save(climatch.aa.90.370, file="climatch.aa.90.370.Rda")
save(climatch.aa.90.585, file="climatch.aa.90.585.Rda")

# Terrestrial ecoregions climatch
# Terrrestrial plants and animals
climatch.tp.hist<-climatchpair(recipient = clim.dat.teow.hist, source = clim.dat.teow.hist, globalvar = glob.var.hist[tp], biovar = tp)
climatch.tp.90.370<-climatchpair(recipient = clim.dat.teow.90.370, source = clim.dat.teow.90.370, globalvar = glob.var.90.370[tp], biovar = tp)
climatch.tp.90.585<-climatchpair(recipient = clim.dat.teow.90.585, source = clim.dat.teow.90.585, globalvar = glob.var.90.585[tp], biovar = tp)

save(climatch.tp.hist, file="climatch.tp.hist.Rda")
save(climatch.tp.90.370, file="climatch.tp.90.370.Rda")
save(climatch.tp.90.585, file="climatch.tp.90.585.Rda")

# Terrestrial animals
climatch.ta.hist<-climatchpair(recipient = clim.dat.teow.hist, source = clim.dat.teow.hist, globalvar = glob.var.hist[ta], biovar = ta)
climatch.ta.90.370<-climatchpair(recipient = clim.dat.teow.90.370, source = clim.dat.teow.90.370, globalvar = glob.var.90.370[ta], biovar = ta)
climatch.ta.90.585<-climatchpair(recipient = clim.dat.teow.90.585, source = clim.dat.teow.90.585, globalvar = glob.var.90.585[ta], biovar = ta)

save(climatch.ta.hist, file="climatch.ta.hist.Rda")
save(climatch.ta.90.370, file="climatch.ta.90.370.Rda")
save(climatch.ta.90.585, file="climatch.ta.90.585.Rda")




