
# Code is associated with the following sections of the article

# Methods
# Prior to running climate matches, here extract individual ecoregion climate (PCA-derived variables) data into matrices

# clean working environment
rm(list=ls())

library(raster)
library(sp)
library(rgdal)
library(proj4)


teow<-shapefile("teow.shp")
# Remove ecoregions which are Rock and Ice (interior Antarctica and Greenland), Lakes (largest lakes), 
# and several small island ecoregions without climate data 
teow<-teow[-c(119, 201, 249, 726, 785, 827),]

# Check mean area of teow
mean(teow$AREA)
# Load freshwater ecoregions
feow<-shapefile("feow.shp")
# Retain spatial polygons of only described ecoregions from Abell et al. 2008
feow<-feow[1:426,] 
# Set projection
crs(feow)<-"+proj=longlat +datum=WGS84 +no_defs" 
# Check mean area of feow
mean(feow$AREA_SKM)
mean(teow$AREA)

############

# Load climate data
clim.hist<-stack("hist.clim.tif")
clim.90.370<-stack('CE.2090.370.tif')
clim.90.585<-stack('CE.2090.585.tif')

# Historical climates
glob.var.hist<-cellStats(clim.hist, stat="sd")^2
glob.var.90.370<-cellStats(clim.90.370, stat="sd")^2
glob.var.90.585<-cellStats(clim.90.370, stat="sd")^2
#
save(glob.var.hist, file="glob.var.hist.Rda") 
save(glob.var.90.370, file="glob.var.90.370.Rda")
save(glob.var.90.585, file="glob.var.90.585.Rda")

## Function for generating a list of dataframes of climate data for each ecoregion of each ecoregion set
# Smaller ecoregions typically had large proportions of grid cell centroid fall outside their polygons, 
# to capture those data for small ecoregions those with n < 50 used all grid cells falling within the polygon
climdatlist<-function(clim.dat, ecoset){
  n<-length(ecoset)
  clim.dat.list.ecoreg<-list()
  for(i in 1:n){
    temp<-na.omit(as.data.frame(mask(crop(clim.dat, ecoset[i,]), ecoset[i,])))
    if(nrow(temp)>=50){
      clim.dat.list.ecoreg[[i]]<-temp
    }
    else{
      clim.dat.list.ecoreg[[i]]<- na.omit(as.data.frame(extract(clim.dat, ecoset[i,], weights=T)))[,-20] # Grabs all data
    }
  }
  return(clim.dat.list.ecoreg)
}

# Run the extractions
#Feow
clim.dat.feow.hist <- climdatlist(clim.dat = clim.hist, ecoset = feow)
clim.dat.feow.90.370 <- climdatlist(clim.dat = clim.90.370, ecoset = feow)
clim.dat.feow.90.585 <- climdatlist(clim.dat = clim.90.585, ecoset = feow)

#Teow
clim.dat.teow.hist <- climdatlist(clim.dat = clim.hist, ecoset = teow)
clim.dat.teow.90.370 <- climdatlist(clim.dat = clim.90.370, ecoset = teow)
clim.dat.teow.90.585 <- climdatlist(clim.dat = clim.90.585, ecoset = teow)

save(clim.dat.feow.hist, file="clim.dat.feow.hist.Rda")
save(clim.dat.feow.90.370, file="clim.dat.feow.90.370.Rda")
save(clim.dat.feow.90.585, file="clim.dat.feow.90.585.Rda")

save(clim.dat.teow.hist, file="clim.dat.teow.hist.Rda")
save(clim.dat.teow.90.370, file="clim.dat.teow.90.370.Rda")
save(clim.dat.teow.90.585, file="clim.dat.teow.90.585.Rda")

### Terrestrial ecoregions
# Historical
dat.length.eco.c<-vector()
for(i in 1:length(clim.dat.feow.hist)){
  dat.length.eco.c[i]<-nrow(clim.dat.feow.hist[[i]])
}
min(dat.length.eco.c) 
dat.l<-order(dat.length.eco.c)
dat.l
dat.length.eco.c[dat.l[1:426]]

